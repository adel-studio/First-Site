<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Furniture App PoC</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1 { margin-bottom: 24px; }
    h2 { margin-top: 32px; }
    .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 16px; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 12px; background: #fafafa; }
    .card img { width: 100%; height: 220px; object-fit: cover; border-radius: 8px; }
    @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>Furniture Picks</h1>

  <section>
    <h2>Top 3 Picks</h2>
    <div id="top-3" class="grid"></div>
  </section>

  <section>
    <h2>More You Might Like</h2>
    <div id="more-10" class="grid"></div>
  </section>

  <section>
    <h2>Search Products</h2>
    <input id="search" placeholder="Search (e.g., sofa, marble, walnut)" />
    <div id="results" class="grid" style="margin-top: 12px;"></div>
  </section>

  <!-- Config (your Supabase URL + anon key) -->
  <script src="/config.js"></script>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- App logic -->
  <script>
    const client = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);

    async function loadProducts() {
      // Top 3 featured
      const { data: featured, error: fErr } = await client
        .from('products')
        .select('*')
        .eq('featured', true)
        .order('created_at', { ascending: false })
        .limit(3);
      if (fErr) console.error(fErr);

      // Next 10 non-featured
      const { data: more, error: mErr } = await client
        .from('products')
        .select('*')
        .eq('featured', false)
        .order('created_at', { ascending: false })
        .limit(10);
      if (mErr) console.error(mErr);

      // Render both sections
      render('#top-3', featured || []);
      render('#more-10', more || []);
    }

    function render(sel, items) {
      const el = document.querySelector(sel);
      if (!el) return;
      el.innerHTML = items.map(p => `
        <article class="card">
          <img src="${p.image_url || ''}" alt="${p.title || ''}" />
          <h3>${p.title || ''}</h3>
          <p>${(p.brand || '')}${p.brand && p.category ? ' • ' : ''}${p.category || ''}</p>
          <p>${p.price ? ('$' + Number(p.price).toFixed(2) + ' ' + (p.currency || 'USD')) : ''}</p>
          <a href="${p.product_url || '#'}" target="_blank" rel="noopener">View</a>
        </article>
      `).join('');
    }

    // --- SEARCH FEATURE ---
    const searchBox = document.querySelector('#search');
    searchBox?.addEventListener('input', debounce(runSearch, 300));

    async function runSearch() {
      const q = searchBox.value.trim();
      if (!q) {
        document.querySelector('#results').innerHTML = '';
        return;
      }

      const { data, error } = await client
        .from('products')
        .select('*')
        .or(`title.ilike.%${q}%,brand.ilike.%${q}%,category.ilike.%${q}%`)
        .limit(20);

      if (error) {
        console.error(error);
        return;
      }

      document.querySelector('#results').innerHTML = (data || []).map(p => `
        <article class="card">
          <img src="${p.image_url || ''}" alt="${p.title || ''}" />
          <h3>${p.title || ''}</h3>
          <p>${(p.brand || '')}${p.brand && p.category ? ' • ' : ''}${p.category || ''}</p>
          <p>${p.price ? ('$' + Number(p.price).toFixed(2) + ' ' + (p.currency || 'USD')) : ''}</p>
          <a href="${p.product_url || '#'}" target="_blank" rel="noopener">View</a>
        </article>
      `).join('');
    }

    function debounce(fn, wait) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      };
    }

    loadProducts();
  </script>
</body>
</html>
